name: PoC - One dynamic required check (fake)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  identify:
    name: Identify required steps
    runs-on: ubuntu-latest
    outputs:
      req_localpr: ${{ steps.detect.outputs.req_localpr }}
    steps:
      - name: Checkout (full history for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect if PR formalities are required
        id: detect
        shell: bash
        run: |
          set -euo pipefail

          BASE_REF="origin/${{ github.base_ref }}"
          git fetch origin "${{ github.base_ref }}" --depth=1 || true

          req_localpr=false

          # If anything changed under src/, require localPR-validate
          if ! git diff --quiet "$BASE_REF"...HEAD -- src/; then
            req_localpr=true
          fi

          echo "req_localpr=$req_localpr" >> "$GITHUB_OUTPUT"
          echo "req_localpr=$req_localpr"

  localPR-validate:
    name: localPR-validate (fake)
    runs-on: ubuntu-latest
    needs: identify
    if: needs.identify.outputs.req_localpr == 'true'
    steps:
      - name: Fake PR formalities validation
        run: |
          echo "FAKE: PR formalities validation running..."
          sleep 10
          echo "FAKE: PR formalities validation OK"

  required-checks:
    name: All required steps check
    runs-on: ubuntu-latest
    needs:
      - identify
      - localPR-validate
    if: always()
    steps:
      - name: Enforce required checks
        shell: bash
        run: |
          set -euo pipefail

          req_localpr="${{ needs.identify.outputs.req_localpr }}"
          res_localpr="${{ needs.localPR-validate.result }}"

          echo "Required? localPR=$req_localpr"
          echo "Result:   localPR=$res_localpr"

          if [[ "$req_localpr" == "true" && "$res_localpr" != "success" ]]; then
            echo "::error::localPR-validate was required but result=$res_localpr"
            exit 1
          fi

          echo "All required checks passed."
