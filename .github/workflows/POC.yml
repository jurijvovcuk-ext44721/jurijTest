name: PoC - Steps only (fake)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  poc:
    name: PoC - Steps view
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Identify if PR formalities are required (src changed)
        id: identify
        shell: bash
        run: |
          set -euo pipefail
          BASE_REF="origin/${{ github.base_ref }}"
          git fetch origin "${{ github.base_ref }}" --depth=1 || true

          # Default: not required
          req_localpr=false

          # If anything changed under src/, require formalities
          if ! git diff --quiet "$BASE_REF"...HEAD -- src/; then
            req_localpr=true
          fi

          echo "req_localpr=$req_localpr" >> "$GITHUB_OUTPUT"
          echo "Decision: req_localpr=$req_localpr"

      - name: localPR-validate (fake)
        id: localpr
        if: steps.identify.outputs.req_localpr == 'true'
        shell: bash
        run: |
          set -euo pipefail
          echo "FAKE: PR formalities validation running..."
          sleep 10
          echo "FAKE: PR formalities validation OK"

      - name: All required steps check (gate)
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          req="${{ steps.identify.outputs.req_localpr }}"
          formalities_outcome="${{ steps.localpr.outcome }}"

          echo "Required? localPR=$req"
          echo "Formalities step outcome=$formalities_outcome"

          # If required, the step must have succeeded
          if [[ "$req" == "true" && "$formalities_outcome" != "success" ]]; then
            echo "::error::Formalities were required but did not succeed"
            exit 1
          fi

          echo "Gate passed."
