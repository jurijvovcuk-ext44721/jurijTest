name: PoC - Identify then validate (fake)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  identify:
    name: Identify required steps
    runs-on: ubuntu-latest
    outputs:
      req_localpr: ${{ steps.detect.outputs.req_localpr }}
    steps:
      - name: Checkout PR head (full history for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - name: Detect if src changed
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          BASE_REF="origin/${{ github.base_ref }}"
          git fetch origin "${{ github.base_ref }}" --depth=1 || true

          req_localpr=false
          if ! git diff --quiet "$BASE_REF"...HEAD -- src/; then
            req_localpr=true
          fi

          echo "req_localpr=$req_localpr" >> "$GITHUB_OUTPUT"
          echo "Decision: req_localpr=$req_localpr"

  localpr_validate:
    name: localPR-validate (fake)
    runs-on: ubuntu-latest
    needs: identify
    if: needs.identify.outputs.req_localpr == 'true'
    steps:
      - name: Fake PR formalities validation
        run: |
          echo "FAKE: PR formalities running..."
          sleep 10
          echo "FAKE: OK"

  required_checks:
    name: All required steps check
    runs-on: ubuntu-latest
    needs: [identify, localpr_validate]
    if: always()
    steps:
      - name: Gate
        shell: bash
        run: |
          set -euo pipefail

          req="${{ needs.identify.outputs.req_localpr }}"
          res="${{ needs.localpr_validate.result }}"

          echo "Required? $req"
          echo "Validation job result: $res"

          if [[ "$req" == "true" && "$res" != "success" ]]; then
            echo "::error::localPR-validate was required but result=$res"
            exit 1
          fi

          echo "Gate passed."
